# Working with 'tar' Archives

In this exercise we will use the `tar` command to work with archives. The exercise assumes you have read the section called *Archiving Data* in textbook Chapter 10.

## 1. Create a Directory for This Exercise

Create a new directory called `~/archex` (for *arch*ive *ex*ercise) and `cd` into it. For the rest of the exercise I'll simply refer to this dir as `archex`.

Notice that the directory is not in your `~/playground` directory. I did this on purpose, because we are going to practice making archives of our `~/playground` directory, and we can get in trouble if we try to create an archive in a directory we're in the process of backing up. Think of a snake trying to swallow its own tail.

## 2. Learn by Example

This section will show you examples of the basic operations when you work with `tar` files. In the following section, called *Your Turn!*, you will be asked to enter commands to do similar things. But it's good practice to try the commands in this section too.

### 2.1 Create and Compress an Archive

Often when we create an archive we also want to compress it. There are multiple ways to compress an archive. I can do it as an option to the `tar` command, or I can do it in a separate step. Below are two ways to create a compressed archive of the `/etc/firefox` directory.

Both of these methods will create a compressed archive called `fox.tar.gz`. (I use the `#` character for descriptive comments; you don't need to type those lines in). Choose *one* of these methods to create the archive:

	# method 1: all in one step
	tar --create --file=fox.tar.gz --gzip /etc/firefox

	# method 2: two separate steps
	tar --create --file=fox.tar /etc/firefox
	gzip fox.tar

The first method uses `tar` both to create the archive and also to compress it using the `--gzip` option. With the second method, `tar` only creates the archive. The archive is then compressed with a separate command called `gzip`. Both methods create the same compressed archive.

Note that the `tar` command prints the message: "tar: Removing leading '/' from member names." This is good! We want to create archives with relative paths, so that if and when we extract something from the archive, it will be extracted relative to our current directory and not to its original location.

Why does `tar` do this? Here's an example: If a friend who is a Linux administrator sends me an archive of his `/etc` directory and the leading slash isn't removed, when I extract it I will overwrite my own `/etc` directory, which I definitely do not want to do! If the leading slash is removed when the archive is created, the files will be extracted to whatever my current directory is when I extract the archive.

### 2.2 List the Archive Contents

We can list the contents of an archive by using the `--list` option. The output prints one line for each directory and one line for each file. We can tell which ones are the directories because those lines end with a slash. We can list the contents of an entire archive like this:

	tar --list --file=fox.tar.gz

The output for our archive should look something like this:

	etc/firefox/
	etc/firefox/syspref.js
	etc/firefox/pref/
	etc/firefox/pref/apturl.js

This is a list of every file and every directory in the archive; the format is similar to the output generated by the `find` command. Based on the trailing slashes, which signify directories, we can see that there are two things in the `etc/firefox` directory: a JavaScript file named `syspref.js`, and a `pref` subdirectory that contains JavaScript file `apturl.js`. Notice that the leading slashes are gone from the absolute path (`/etc/firefox`) we specified when we created the archive.

### 2.3 Extract the Entire Archive

Extracting the entire archive is easy:

	tar --extract --file=fox.tar.gz

Remember that the archive gets extracted into the current directory. If we now list the contents of the current directory, we'll find a new `etc` directory. Within that will be a `firefox` directory, and so on. If we are in our `archex` directory when we do the extraction, the absolute path to the extracted `apturl.js` file will be:

	~/archex/etc/firefox/pref/apturl.js

It may seem like a hassle to have to `cd` into three directories (starting from `archex`) just to find `apturl.js`, but `tar` must behave this way, in case the archive contains multiple files with the same name but in different directories. You could have various files called `foo.txt` in different directories -- I know I do ;-) -- and we can't afford to have them overwrite each other, so we have to extract them to the same relative location (from the top of the archive) as in the archive.

### 2.4 Create an Incremental Backup

Now that we've done the basic create/list/extract operations, let's try some more interesting things.

If I want to regularly back up my files, but I don't want to waste space by always backing up files that never change, I can tell `tar` to choose which files to back up based on the last modified date of each file. Using the `--after-date` option, I can specify how far back in time I want `tar` to look for modified files. There are various ways to specify this:

* Give a specific date/time, for example: `--after-date='2004-02-29 16:21:42'`
* Give the path to a file whose last modified stamp should be used as the date/time. The path must begin with either a forward slash or a period (for the current directory), for example: `--after-date=./backup.stamp`
* Use quasi-English to specify a relative date/time, for example: `--after-date='1 week ago'`

For our example, let's back up files in `/etc/firefox` that have been modified within the past month. However all of the files in that directory haven't been modified for a long time, so we'll `touch` one of them so that it is included in our incremental backup:<

	sudo touch /etc/firefox/syspref.js

(We have to use `sudo` to `touch` that file because it belongs to the system.) Now we can make an incremental backup of only the files that have been modified in the past month:

	tar --create --file=fox-incr.tar --after-date='1 month ago' /etc/firefox

What this command does: We are telling (or asking?) `tar` to create an archive with the filename `fox-incr.tar`, and it should include any files in `/etc/firefox` or its subdirectories that have been modified within the past month.

If we list the archive we can see that it only contains the one file (but all of the directories):

	tar --list --file=fox-incr.tar

### 2.5 List Only Files in the Archive

An annoying "feature" when listing the contents of incremental backups is that every directory is included, even if no file in that directory was modified. Therefore if I back up a huge directory where only one file was modified, and I want to list the contents, `tar` will list all the directories too, and I'll have a hard time finding the single file that was modified. For that reason it's useful to only list the files in the archive.

There isn't a `tar` option to do this, but rather an option of our old friend `grep`. I can pipe the archive listing into the `grep` command, because I know that `grep` can be used to filter out what I don't want. But I usually tell `grep` what I want to see, and not what I *don't* want to see. For example, if I type `grep apache`, it will output all lines that contain "apache," not all lines that don't. Is there any way to reverse `grep`'s behavior? If I look at the `man` page, I find the answer: The `--invert-match` option (or short option `-v`) will only print lines that do *not* match.

So what pattern should I use if I want to see files but not directories? I know that a directory has a forward slash as the last character on the line. But how do I specify the last character on the line? Here's how: The dollar sign has special significance in *regular expressions* (which we unfortunately don't have enough time to learn about), in that it specifies the end of the line. So specifying the pattern '/$' means match any line that contains a forward slash as the last character on the line. Since we're interested in files and not directories, we'll use `grep`'s `--invert-match` option to only show lines that do not end with a slash. Here we add our `grep` command to show only the files in the incremental archive we just created:

	tar --list --file=fox-incr.tar | grep --invert-match '/$'

We can see that the output from this command shows us only the files, and no directories.

If we only wanted to know how many files are in the archive, we could add `wc -l` (that's the letter "el") on the end of the line with another pipe:

	tar --list --file=fox-incr.tar | grep --invert-match '/$' | wc -l

That would be a good way to answer the question: How many files are in archive `fox-incr.tar`? True, in our example the archive is small so it's easy to count the files. But the line above is very useful when you have thousands (or even *gazillions*!) of files and directories in an archive.

### 2.6 Extract One File From the Archive

We've already extracted an entire archive. But sometimes we only want to extract one or two files from a large archive. To do this, we need to give `tar` the *exact* relative path of the file(s) we want to extract. The best way to determine the exact relative path is to find the desired file(s) in the archive list. If we look at the archive list of `fox.tar.gz` above, and let's say we only want to extract the file `syspref.js`, we would extract it like this:

	tar --extract --file=fox.tar.gz etc/firefox/syspref.js

Just like extracting the full archive, it will create all the necessary directories -- in this case `etc` and `firefox` -- in order to place the file `syspref.js` in the right place relative to the current directory. So even if we are extracting a single file, if it is located deep in a directory structure, you will have to specify the entire relative path in the archive, and that directory structure will be reproduced in the current directory when you extract the file.

## 3. Your Turn!

Now it's your turn to practice making some backups of your `~/playground` directory. You'll store them in `~/archex` just as we did in the examples above.

This part assumes that you have at least partially completed the Files & Dirs exercise. If you have not started it, please tell your friendly instructor.

### 3.1 Make a Complete Backup

Make a backup of your `~/playground` directory, using `gzip` compression. Call it `complete.tgz`, where "complete" means a complete (and not incremental) backup. Be sure you use an absolute path when specifying the directory to be backed up. Once you have created the backup, how many files are in it?

### 3.2 Make an Incremental Backup

Make an incremental backup of only those files in your `~/playground` directory that have been modified within the past five weeks (`'5 weeks ago'`). Call it `incr.tar`, which means (if we're to believe file extensions) that it's an uncompressed incremental backup. Again, use an absolute path to specify the directory to back up. How many files are in this backup? (It had better be fewer than in your complete backup.)

### 3.3 Extract the Complete Backup

Extract `complete.tgz` into your `~/archex` directory (which should be your current directory). If you succeed, you'll have a directory called `home` in your `~/archex` directory that wasn't there before. Here's how you can see how many files are in it:

	find home -type f | wc -l

Here the `-type` option of the `find` command will only list files; it'll skip directories. The number of files should be the same as the number found in Step 3.1.

### 3.4 Extract a Single Directory from a Backup

Before you can do another extraction you need to rename the `home` directory you just extracted so it doesn't get overwritten. Rename `home` to be `home-complete`.

Now extract the `files-dirs` directory from your complete backup. You'll want to look at an archive listing to see what the exact relative path in the archive is. After you extract the single directory, you will once again have a `~/archex/home` directory, but it should be smaller than in Step 3.3 because you (hopefully) only extracted one exercise directory. How many files did you get?

## 4. Clean Up

Assuming that everything worked fine and your archiving skills are now awesome, you can clean up. What exactly do I mean by "clean up"? For some exercises you have created an exercise directory in `~/playground` to hold files you're working with. But I specifically asked you to place `archex` *outside* of `playground` this time, to avoid "snake eats tail" problems while you were creating archives. Now that you're done, you don't have that problem anymore, so you can move `archex` into `playground`, with the result that once again all of your exercise directories are in `~/playground` and your home directory is neat and tidy.